<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Always, In Every Version</title>
  <style>
    :root{
      --bg:#07070b;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text:#f4f4f7;
      --muted: rgba(255,255,255,.75);
      --btn:#ff4d88;
      --btn2: rgba(255,255,255,.14);
      --warn:#ffd1e0;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      -webkit-font-smoothing:antialiased;
      padding:18px;
    }
    .wrap{max-width:840px;margin:0 auto}
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:18px;
    }
    h1{font-size:18px;margin:0 0 10px}
    p{line-height:1.55;margin:10px 0;color:var(--text)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input{
      padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);min-width:210px;
    }
    button{
      cursor:pointer;border:0;border-radius:14px;padding:11px 13px;
      background:var(--btn);color:white;font-weight:700;
    }
    button.secondary{background:var(--btn2)}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .hud{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.18);
      margin-top:14px;
      font-size:12px;
    }
    .pill{
      padding:5px 8px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .divider{height:1px;background:rgba(255,255,255,.10);margin:14px 0}
    .tiny{font-size:12px;color:var(--muted);margin-top:10px}
    .k{color:var(--warn);font-weight:800}
    .center{ text-align:center; padding:34px 10px; }
    .big{ font-size:20px; letter-spacing:.6px; font-weight:900; color:var(--warn); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">Always, In Every Version</h1>
      <div id="screen"></div>
      <div class="hud" id="hud"></div>
      <p class="tiny">Tip: If audio doesn’t start, tap anywhere once—iOS requires a user interaction.</p>
    </div>
  </div>

<script>
const CONFIG = {
  playerCanonicalName: "Bryan",
  oracleRevealName: "Lenzie",
  pets: { dog:"Benjie", cat:"Belle" },
  businesses: { tarot:"TarotPH", books:"BookDropPH" },
  spice: 3,
  revealSpeedMs: 900,
};

const S = {
  playerName: "",
  stats: { resonance:0, restraint:0, dominance:0, intuition:0, competition:0, benjie:0, belle:0 },
  flags: { touched:false, confessed:false, acceptedUnknown:false },
  inv: [],
};

const AUDIO = { ctx:null, master:null, osc1:null, osc2:null, lfo:null, lfoGain:null, started:false };

function ensureAudio(){
  if (AUDIO.started) return;
  try{
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    AUDIO.ctx = new AudioContext();
    AUDIO.master = AUDIO.ctx.createGain();
    AUDIO.master.gain.value = 0.0;
    AUDIO.master.connect(AUDIO.ctx.destination);

    AUDIO.osc1 = AUDIO.ctx.createOscillator();
    AUDIO.osc2 = AUDIO.ctx.createOscillator();
    AUDIO.osc1.type = "sine";
    AUDIO.osc2.type = "triangle";
    AUDIO.osc1.frequency.value = 110;
    AUDIO.osc2.frequency.value = 220;

    const g1 = AUDIO.ctx.createGain();
    const g2 = AUDIO.ctx.createGain();
    g1.gain.value = 0.07;
    g2.gain.value = 0.05;

    AUDIO.lfo = AUDIO.ctx.createOscillator();
    AUDIO.lfo.type = "sine";
    AUDIO.lfo.frequency.value = 0.12;
    AUDIO.lfoGain = AUDIO.ctx.createGain();
    AUDIO.lfoGain.gain.value = 8;

    AUDIO.lfo.connect(AUDIO.lfoGain);
    AUDIO.lfoGain.connect(AUDIO.osc2.frequency);

    AUDIO.osc1.connect(g1); AUDIO.osc2.connect(g2);
    g1.connect(AUDIO.master); g2.connect(AUDIO.master);

    AUDIO.osc1.start(); AUDIO.osc2.start(); AUDIO.lfo.start();
    AUDIO.started = true;
  }catch(e){
    AUDIO.started = false;
  }
}
function audioFadeTo(target, ms){
  if (!AUDIO.started || !AUDIO.master || !AUDIO.ctx) return;
  const now = AUDIO.ctx.currentTime;
  const g = AUDIO.master.gain;
  g.cancelScheduledValues(now);
  g.setValueAtTime(g.value, now);
  g.linearRampToValueAtTime(target, now + (ms/1000));
}
function audioStartSoft(){ ensureAudio(); if (!AUDIO.started) return; audioFadeTo(0.18, 1500); }
window.addEventListener("pointerdown", () => audioStartSoft(), { once:true });

function addItem(item){ if (!S.inv.includes(item)) S.inv.push(item); }
function clampStat(k, min, max){ S.stats[k]=Math.max(min,Math.min(max,S.stats[k])); }
function addStat(k,n){ S.stats[k]+=n; clampStat(k,-9,12); }

function tmpl(str){
  return String(str)
    .replaceAll("{player}", S.playerName || "Player")
    .replaceAll("{canon}", CONFIG.playerCanonicalName)
    .replaceAll("{oracleName}", CONFIG.oracleRevealName)
    .replaceAll("{dog}", CONFIG.pets.dog)
    .replaceAll("{cat}", CONFIG.pets.cat)
    .replaceAll("{tarot}", CONFIG.businesses.tarot)
    .replaceAll("{books}", CONFIG.businesses.books);
}
function lineSpice(base, spicy){
  if (CONFIG.spice >= 3) return spicy;
  if (CONFIG.spice === 2) return base;
  return base.replaceAll("breath", "voice").replaceAll("hunger", "heat");
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function computeEndingKey(){
  const st = S.stats;
  const balancedDominance = (st.dominance >= 2 && st.dominance <= 5);
  const secret = st.resonance >= 8 && st.restraint >= 4 && balancedDominance && st.intuition >= 4 && st.belle >= 2 && S.flags.acceptedUnknown;
  if (secret) return "ending_secret_constant";
  const best = st.resonance >= 7 && st.restraint >= 3 && balancedDominance && st.competition >= 2 && (st.benjie + st.belle) >= 3;
  if (best) return "ending_shared_life";
  if (st.competition >= 5 && st.dominance >= 5 && st.resonance >= 4) return "ending_power_couple";
  if (st.restraint >= 5 && st.resonance <= 5) return "ending_waiting_timeline";
  if (st.intuition >= 5 && st.belle >= 3) return "ending_parallel_walk";
  return "ending_shared_life_soft";
}

const FINAL_NARRATION_LINES = [
  "You reach the end of the path.",
  "There is no boss.",
  "No final trial.",
  "Only a quiet clearing, lit by a familiar calm.",
  "",
  "The Oracle is already there.",
  "",
  "She steps closer, and for the first time, the distance disappears.",
  "Not as a rule breaking —",
  "but as a truth settling into place.",
  "",
  "“You’ve been walking for a long time,” she says softly.",
  "“I didn’t lead you forward.",
  "I only made sure you were never walking alone.”",
  "",
  "She reaches for you and pulls you into an embrace.",
  "It feels like rest.",
  "Like home.",
  "",
  "“I was there at the beginning,” she continues.",
  "“Before the paths split.",
  "Before the worlds multiplied.”",
  "",
  "And then she finally says her name.",
  "",
  "“I’m Lenzie.”",
  "",
  "The name doesn’t surprise you.",
  "It feels remembered.",
  "",
  "She smiles, forehead resting against yours.",
  "",
  "“We started with something simple.",
  "Just a hello.",
  "And look at how far we’ve gone.”",
  "",
  "Around you, the worlds you crossed feel smaller now.",
  "Not insignificant — just complete.",
  "",
  "“If you ever find yourself in another universe,” she whispers,",
  "“I hope you recognize us again.”",
  "",
  "“And if we were ever given the chance to rewrite our story…”",
  "",
  "She pauses.",
  "Not for effect.",
  "But because this part matters.",
  "",
  "“I wouldn’t choose any path",
  "that doesn’t lead to you.”",
  "",
  "She holds you a little tighter.",
  "",
  "I love you.",
  "",
  "Happy Valentine’s.",
];

let revealIndex = 0;
let revealTimer = null;
let hugFaded = false;

function startReveal(){
  revealIndex = 0;
  hugFaded = false;
  if (revealTimer) { clearInterval(revealTimer); revealTimer = null; }
  const box = document.getElementById("reveal");
  if (box) box.innerHTML = "";
}
function revealNext(){
  const box = document.getElementById("reveal");
  if (!box) return;

  if (revealIndex >= FINAL_NARRATION_LINES.length){
    render("final_screen");
    return;
  }

  const raw = FINAL_NARRATION_LINES[revealIndex];
  const line = tmpl(raw);
  revealIndex++;

  if (raw === "She reaches for you and pulls you into an embrace." && !hugFaded){
    audioFadeTo(0.0, 2600);
    hugFaded = true;
  }

  const p = document.createElement("p");
  p.innerHTML = line === "" ? "&nbsp;" : line;
  box.appendChild(p);
  box.lastElementChild?.scrollIntoView({ behavior:"smooth", block:"end" });

  const nextBtn = document.getElementById("nextBtn");
  if (nextBtn && revealIndex >= FINAL_NARRATION_LINES.length) nextBtn.textContent = "Finish";
}
function autoReveal(){
  if (revealTimer) return;
  revealTimer = setInterval(()=>{
    revealNext();
    if (revealIndex >= FINAL_NARRATION_LINES.length){
      clearInterval(revealTimer);
      revealTimer = null;
    }
  }, CONFIG.revealSpeedMs);
}
function skipReveal(){ render("final_screen"); }

const SCENES = {
  intro: {
    title: "Always, In Every Version",
    custom(){
      return `
        <p class="muted">You are the player. You are not told why you’re here.</p>
        <p>Type a name to begin.</p>
        <div class="row">
          <input id="nm" maxlength="18" placeholder="Name (default: ${CONFIG.playerCanonicalName})" />
          <button onclick="saveName()">Begin</button>
        </div>
        <div class="divider"></div>
        <p class="muted">Every ending ends with you together.</p>
        <p class="muted">After your ending, a final narration will play — line by line.</p>
      `;
    }
  },

  act1_signal: {
    title: "ACT I — The First Signal",
    text: [
      "A notification flashes in a place that isn't quite a phone, and isn't quite a dream.",
      "One message waits like a held breath:",
      "<span class='k'>“May I speak with you?”</span>",
      "You don't know who sent it. You only know it was meant for you."
    ],
    choices: [
      { label:"Reply immediately", next:"act2_crossing", effects:()=>{ addStat("resonance",1); addStat("dominance",1); addStat("competition",1);} },
      { label:"Read twice before replying", next:"act2_crossing", secondary:true, effects:()=>{ addStat("intuition",2); addStat("restraint",1); } },
      { label:"Leave it on read (for now)", next:"act2_crossing", secondary:true, effects:()=>{ addStat("restraint",2); addStat("resonance",-1); } },
    ]
  },

  act2_crossing: {
    title: "ACT II — The Crossing",
    text: [
      "The sender does not introduce themself.",
      "Your reply becomes a doorway, and you step through it.",
      "A figure stands in a soft-lit corridor. Not a face — a presence.",
      lineSpice(
        "Their voice is calm. Their silence is sharper than most people's answers.",
        "Their voice is calm. The space between you turns tight, like it’s waiting to be touched."
      ),
      "They speak as if they know you, without ever proving it."
    ],
    choices: [
      { label:"Ask for their name", next:"act2_name", effects:()=>{ addStat("dominance",1); addStat("competition",1);} },
      { label:"Offer your name first", next:"act2_offer", secondary:true, effects:()=>{ addStat("resonance",1); addStat("restraint",1);} },
      { label:"Say nothing. Let them lead.", next:"act2_silence", secondary:true, effects:()=>{ addStat("intuition",1); addStat("resonance",1); addStat("restraint",1); S.flags.acceptedUnknown=true;} },
    ]
  },

  act2_name: {
    title: "The Question",
    text: [
      "“Who are you?” you ask.",
      "The presence tilts their head.",
      "“If I tell you, you’ll hold me like a label.”",
      "“I’m not here to be reduced.”"
    ],
    choices: [
      { label:"Press again", next:"act3_familiars", effects:()=>{ addStat("dominance",2); addStat("resonance",-1);} },
      { label:"Back off (barely)", next:"act3_familiars", secondary:true, effects:()=>{ addStat("restraint",2); addStat("resonance",1);} },
    ]
  },

  act2_offer: {
    title: "The Offer",
    text: [
      "You give your name first.",
      "The corridor warms by a fraction.",
      "“I heard it,” the presence says. “Like it mattered.”",
      "You don't know why that feels intimate."
    ],
    choices: [
      { label:"Challenge them: 'Say yours.'", next:"act3_familiars", effects:()=>{ addStat("dominance",1); addStat("competition",1);} },
      { label:"Let it stay unknown", next:"act3_familiars", secondary:true, effects:()=>{ addStat("resonance",2); addStat("intuition",1); S.flags.acceptedUnknown=true;} },
    ]
  },

  act2_silence: {
    title: "The Silence That Answers",
    text: [
      "You don't chase the name.",
      "Your restraint becomes a key.",
      "The presence steps closer — not as permission, as a test.",
      lineSpice(
        "You notice the way their attention doesn't wander.",
        "You notice the way their attention pins you, steady, like it knows your weak points and loves you for them."
      ),
    ],
    choices: [
      { label:"Hold the eye contact", next:"act3_familiars", effects:()=>{ addStat("resonance",2); addStat("restraint",1);} },
      { label:"Break it first (control the moment)", next:"act3_familiars", secondary:true, effects:()=>{ addStat("dominance",2); addStat("resonance",-1);} },
    ]
  },

  act3_familiars: {
    title: "ACT III — The Familiar Bond",
    text: [
      "Before you meet the presence again, you meet two creatures in the Threshold Grove.",
      "A beagle trots up like you belong here.",
      "A smoke-colored cat watches like it already knows the ending.",
      "Neither of them waits for permission to choose you."
    ],
    choices: [
      { label:`Kneel to ${CONFIG.pets.dog} (instinct)`, next:"act4_mountain", effects:()=>{ addStat("benjie",2); addStat("resonance",1); addItem("Scent Compass"); } },
      { label:`Offer your hand to ${CONFIG.pets.cat} (mystery)`, next:"act4_mountain", secondary:true, effects:()=>{ addStat("belle",2); addStat("intuition",1); addItem("Smoke Thread"); } },
      { label:"Try to win their trust fast (competitive)", next:"act4_mountain", effects:()=>{ addStat("competition",2); addStat("benjie",1); addStat("belle",1); } },
    ]
  },

  act4_mountain: {
    title: "ACT IV — The Mountain That Watches",
    text: [
      "The path becomes vertical.",
      "You climb with the presence beside you — close enough to feel, not close enough to claim.",
      lineSpice(
        "The wind steals words from your mouth before you can commit to them.",
        "The wind presses you together on narrow ledges. Your breath catches when you realize how easily closeness turns into hunger."
      ),
      "At a narrow pass, the presence pauses. The world waits."
    ],
    choices: [
      { label:"Reach out to steady them", next:"act4_touch", effects:()=>{ S.flags.touched=true; addStat("resonance",2); addStat("dominance",1);} },
      { label:"Hold back. Let them find balance", next:"act5_tarot", secondary:true, effects:()=>{ addStat("restraint",2); addStat("resonance",1);} },
      { label:"Tease: 'You okay?'", next:"act4_tease", secondary:true, effects:()=>{ addStat("competition",1); addStat("dominance",1); addStat("resonance",1);} },
    ]
  },

  act4_touch: {
    title: "Contact",
    text: [
      "Your hand finds them.",
      lineSpice("It’s brief. Necessary.","It’s brief, but it lands like a confession neither of you said out loud."),
      "They do not pull away.",
      lineSpice("They look at you like you’ve just changed the rules.","They look at you like you’ve just unlocked something you both wanted and feared."),
      "“Careful,” they say, too softly."
    ],
    choices: [
      { label:"Withdraw first (control)", next:"act5_tarot", effects:()=>{ addStat("restraint",1); addStat("dominance",1);} },
      { label:"Hold for one more second", next:"act5_tarot", effects:()=>{ addStat("resonance",2); addStat("belle",1);} },
    ]
  },

  act4_tease: {
    title: "The Tease",
    text: [
      "You say it like a joke.",
      "They smile like it isn't.",
      "“I’m fine,” they answer, and the pause after it is not fine at all.",
      lineSpice("The cliff doesn't feel dangerous.","The cliff isn't what feels dangerous.")
    ],
    choices: [
      { label:"Let the moment breathe", next:"act5_tarot", effects:()=>{ addStat("restraint",2); addStat("resonance",1);} },
      { label:"Push: 'Say what you're thinking.'", next:"act5_tarot", effects:()=>{ addStat("dominance",2); addStat("resonance",-1);} },
    ]
  },

  act5_tarot: {
    title: "ACT V — The Tarot Sanctum",
    text: [
      "A circle of cards lies on stone.",
      "Not fortune-telling. Not answers.",
      "A mechanism.",
      "The presence gestures. “Draw.”",
      "The card you pull doesn’t predict you. It responds to you."
    ],
    choices: [
      { label:"Draw: The High Priestess", next:"act5_priestess", secondary:true, effects:()=>{ addStat("intuition",2); addStat("belle",1); addStat("resonance",1);} },
      { label:"Draw: The Lovers", next:"act5_lovers", effects:()=>{ addStat("resonance",2); addStat("restraint",1);} },
      { label:"Draw: The Devil", next:"act5_devil", effects:()=>{ addStat("dominance",2); addStat("competition",1); addStat("resonance",1);} },
    ]
  },

  act5_priestess: {
    title: "The High Priestess",
    text: [
      "The air changes.",
      "“You listen well,” the presence says.",
      "“That’s why this place keeps opening for you.”",
      "You want to ask what you are to them.",
      "You don’t. And somehow that is the loudest thing you’ve done."
    ],
    choices: [
      { label:"Ask one question carefully", next:"act6_ventures", effects:()=>{ addStat("restraint",2); addStat("resonance",1); S.flags.acceptedUnknown=true;} },
      { label:"Stay silent. Let them speak.", next:"act6_ventures", secondary:true, effects:()=>{ addStat("intuition",2); addStat("resonance",1);} },
    ]
  },

  act5_lovers: {
    title: "The Lovers",
    text: [
      "The card is simple. The feeling isn’t.",
      "The presence steps closer like the world is narrowing on purpose.",
      lineSpice("“Some choices are not choices,” they say.","“Some choices are not choices,” they say, close enough that your focus fractures into want."),
      "“They’re recognition.”"
    ],
    choices: [
      { label:"Confess: 'I want you.'", next:"act6_ventures", effects:()=>{ S.flags.confessed=true; addStat("dominance",2); addStat("resonance",2);} },
      { label:"Restrain: 'I want… to understand.'", next:"act6_ventures", secondary:true, effects:()=>{ addStat("restraint",3); addStat("resonance",1);} },
    ]
  },

  act5_devil: {
    title: "The Devil",
    text: [
      "The card doesn't feel evil.",
      "It feels honest.",
      lineSpice("The presence watches you like you’re both negotiating a line.","The presence watches you like you’re both negotiating the moment before you lose control."),
      "“If you push,” they say, “be ready for what opens.”"
    ],
    choices: [
      { label:"Push anyway", next:"act6_ventures", effects:()=>{ addStat("dominance",3); addStat("resonance",1);} },
      { label:"Hold the line (prove control)", next:"act6_ventures", secondary:true, effects:()=>{ addStat("restraint",3); addStat("resonance",1); } },
    ]
  },

  act6_ventures: {
    title: "ACT VI — The Twin Ventures",
    text: [
      "A floating archive appears: shelves of books, receipts that glow, listings that rearrange themselves.",
      "Next to it, an arcane desk: candles, spreads, the weight of other people's questions.",
      "Two crafts. One life.",
      "The presence doesn’t call it love.",
      "They call it alignment."
    ],
    choices: [
      { label:`Optimize the archive (${CONFIG.businesses.books})`, next:"gate", effects:()=>{ addStat("competition",3); addStat("resonance",1); addItem("Ledger Key"); } },
      { label:`Read the circle (${CONFIG.businesses.tarot})`, next:"gate", secondary:true, effects:()=>{ addStat("intuition",3); addStat("resonance",1); addItem("Arcana Thread"); } },
      { label:"Build a system that includes both", next:"gate", effects:()=>{ addStat("competition",2); addStat("intuition",2); addStat("resonance",2); addItem("Convergence Blueprint"); } },
    ]
  },

  gate: {
    title: "FINAL — The Gate of Convergence",
    text: [
      "A gate stands ahead, carved with symbols you feel rather than understand.",
      "The presence turns to you.",
      lineSpice("“If you step through,” they say, “you won’t get the same version back.”","“If you step through,” they say, “you won’t get the same version back… and you might not survive how much you’ll want what’s on the other side.”"),
      "You realize you still don't know their name.",
      "And you realize it doesn't matter — not because names are irrelevant, but because you already chose them."
    ],
    choices: [
      { label:"Step through", next:"ending_router", effects:()=>{ addStat("resonance",1); } },
      { label:"Ask for their name first", next:"ending_router", secondary:true, effects:()=>{ addStat("dominance",1); } },
      { label:"Say nothing. Offer your hand.", next:"ending_router", secondary:true, effects:()=>{ addStat("restraint",1); addStat("resonance",1); S.flags.acceptedUnknown=true; } },
    ]
  },

  ending_router: {
    title: "ENDING",
    onEnter(){ render(computeEndingKey()); },
    dynamicText(){ return []; },
    choices: []
  },

  ending_shared_life: {
    title: "ENDING — The Shared Life",
    text: [
      "You step through the gate and the world resolves into something real.",
      "Not a fantasy — a life.",
      "{oracleName} is beside you like the most natural conclusion.",
      "You don’t ask how you got here. You only notice how calm you feel being close to her."
    ],
    choices: [
      { label:"Continue", next:"final_letter" },
      { label:"See run summary", next:"stats", secondary:true },
    ]
  },

  ending_shared_life_soft: {
    title: "ENDING — The Shared Life (Soft)",
    text: [
      "You step through the gate and wake with a certainty you can’t explain.",
      "{oracleName} is there — not dramatic, not loud. Just present.",
      "Your hand finds hers like a habit you never learned, yet always had."
    ],
    choices: [
      { label:"Continue", next:"final_letter" },
      { label:"See run summary", next:"stats", secondary:true },
    ]
  },

  ending_parallel_walk: {
    title: "ENDING — The Parallel Walk",
    text: [
      "The gate opens into a city you don’t recognize, under a sky that feels slightly wrong.",
      "{oracleName} stands beside you like she has always been there.",
      "The details are different. The bond is identical."
    ],
    choices: [
      { label:"Continue", next:"final_letter" },
      { label:"See run summary", next:"stats", secondary:true },
    ]
  },

  ending_waiting_timeline: {
    title: "ENDING — The Waiting Timeline",
    text: [
      "The gate opens and the air tastes like almost.",
      "You and {oracleName} are together — but something is delayed, intentionally.",
      "She knows more than you do. She doesn’t weaponize it."
    ],
    choices: [
      { label:"Continue", next:"final_letter" },
      { label:"See run summary", next:"stats", secondary:true },
    ]
  },

  ending_power_couple: {
    title: "ENDING — The Power Couple",
    text: [
      "The gate opens into a workshop of creation: listings, schedules, decks, plans.",
      "{oracleName} stands beside you, matching your pace without shrinking your fire.",
      "You build. You grow. You don’t let go."
    ],
    choices: [
      { label:"Continue", next:"final_letter" },
      { label:"See run summary", next:"stats", secondary:true },
    ]
  },

  ending_secret_constant: {
    title: "SECRET ENDING — The Constant",
    text: [
      "The gate opens and the world goes silent, like reality is listening.",
      "{oracleName} looks at you with the calm of someone who has watched you arrive many times.",
      "Different doors. Different worlds. Same hand reaching."
    ],
    choices: [
      { label:"Continue", next:"final_letter" },
      { label:"See run summary", next:"stats", secondary:true },
    ]
  },

  final_letter: {
    title: "FINAL NARRATION",
    custom(){
      return `
        <p class="muted">The story continues… one line at a time.</p>
        <div class="divider"></div>
        <div id="reveal"></div>
        <div class="btns">
          <button id="nextBtn" onclick="revealNext()">Next</button>
          <button class="secondary" onclick="autoReveal()">Auto</button>
          <button class="secondary" onclick="skipReveal()">Skip</button>
        </div>
      `;
    },
    onEnter(){ startReveal(); }
  },

  final_screen: {
    title: "",
    custom(){
      return `
        <div class="center">
          <div class="big">Always. In every version.</div>
          <div class="divider"></div>
          <p class="muted">Happy Valentine’s, Bryan.</p>
          <div class="btns" style="justify-content:center">
            <button onclick="render('intro')">Play again</button>
            <button class="secondary" onclick="render('stats')">Run summary</button>
          </div>
        </div>
      `;
    },
    onEnter(){ audioFadeTo(0.0, 800); }
  },

  stats: {
    title: "Run Summary",
    dynamicText(){
      const k = computeEndingKey();
      const st = S.stats;
      return [
        `Ending: <span class="k">${escapeHtml(k.replaceAll("_"," ").toUpperCase())}</span>`,
        `Resonance: ${st.resonance}`,
        `Restraint: ${st.restraint}`,
        `Dominance: ${st.dominance}`,
        `Intuition: ${st.intuition}`,
        `Competition: ${st.competition}`,
        `${CONFIG.pets.dog} affinity: ${st.benjie}`,
        `${CONFIG.pets.cat} affinity: ${st.belle}`,
        `Items: ${S.inv.length ? escapeHtml(S.inv.join(", ")) : "—"}`
      ];
    },
    choices: [
      { label:"Back to start", next:"intro" },
    ]
  }
};

function render(sceneKey){
  const scene = SCENES[sceneKey];
  if (!scene) return;

  if (scene.onEnter) scene.onEnter();

  const titleEl = document.getElementById("title");
  const screen = document.getElementById("screen");
  const hud = document.getElementById("hud");

  titleEl.textContent = scene.title || "…";

  let html = "";
  if (scene.custom){
    html = scene.custom();
  } else {
    const lines = scene.dynamicText ? scene.dynamicText() : (scene.text || []);
    html += lines.map(t => `<p>${tmpl(t)}</p>`).join("");
    html += `<div class="btns">` + (scene.choices || []).map((c, idx) => {
      const cls = c.secondary ? "secondary" : "";
      return `<button class="${cls}" onclick="choose('${sceneKey}', ${idx})">${c.label}</button>`;
    }).join("") + `</div>`;
  }

  screen.innerHTML = html;

  hud.innerHTML = `
    <div class="row">
      <span class="pill">Player: <b>${escapeHtml(S.playerName || CONFIG.playerCanonicalName)}</b></span>
      <span class="pill">Resonance: <b>${S.stats.resonance}</b></span>
      <span class="pill">Restraint: <b>${S.stats.restraint}</b></span>
      <span class="pill">Dominance: <b>${S.stats.dominance}</b></span>
      <span class="pill">Intuition: <b>${S.stats.intuition}</b></span>
      <span class="pill">Competition: <b>${S.stats.competition}</b></span>
    </div>
    <div class="row">
      <span class="pill">${CONFIG.pets.dog}: <b>${S.stats.benjie}</b></span>
      <span class="pill">${CONFIG.pets.cat}: <b>${S.stats.belle}</b></span>
      <span class="pill">Items: <b>${S.inv.length ? escapeHtml(S.inv.join(", ")) : "—"}</b></span>
    </div>
  `;

  window.location.hash = sceneKey;
}

function choose(sceneKey, idx){
  const scene = SCENES[sceneKey];
  const choice = (scene.choices || [])[idx];
  if (!choice) return;
  if (choice.effects) choice.effects();
  render(choice.next);
}

function saveName(){
  const el = document.getElementById("nm");
  const v = (el?.value || "").trim();
  S.playerName = v || CONFIG.playerCanonicalName;
  audioStartSoft();
  render("act1_signal");
}

render("intro");
</script>
</body>
</html>
